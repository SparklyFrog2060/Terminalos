<!DOCTYPE html>
<html lang="pl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>Terminal płatniczy — symulacja</title>
  <style>
    :root {
      --bg: #0f1115;
      --panel: #141824;
      --accent: #2dd4bf;
      --accent-2: #60a5fa;
      --text: #e5e7eb;
      --muted: #94a3b8;
      --danger: #ef4444;
      --ok: #22c55e;
      --warn: #f59e0b;
      --btn: #1f2937;
      --btn-hover: #263244;
      --screen: #0b0f18;
    }
    * { box-sizing: border-box; }
    body {
      margin: 0; background: var(--bg); color: var(--text);
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, Cantarell, "Helvetica Neue", Arial, "Apple Color Emoji", "Segoe UI Emoji";
      -webkit-font-smoothing: antialiased; line-height: 1.35;
    }
    .wrap {
      min-height: 100dvh; display: grid; place-items: center; padding: 12px;
    }
    .terminal {
      width: min(480px, 100%); background: var(--panel); border-radius: 18px;
      box-shadow: 0 8px 40px rgba(0,0,0,.4); overflow: hidden; border: 1px solid #1f2333;
    }
    .topbar {
      display:flex; justify-content: space-between; align-items: center; padding: 10px 14px;
      background: #0b0e16; border-bottom: 1px solid #1f2333; font-size: 13px; color: var(--muted);
    }
    .screen {
      background: linear-gradient(180deg, #0b0f18, #0b0f18 60%, #0a101c); color: #dbeafe;
      padding: 14px; min-height: 135px; display:flex; flex-direction: column; gap: 8px; justify-content: center;
    }
    .amount {
      font-variant-numeric: tabular-nums; font-weight: 700; font-size: 36px; letter-spacing: .5px;
    }
    .status { color: var(--muted); font-size: 14px; min-height: 20px; }
    .hint { font-size: 12px; color: #8aa2c9; }
    .grid {
      display: grid; grid-template-columns: repeat(3, 1fr); gap: 8px; padding: 12px;
    }
    .btn {
      background: var(--btn); color: var(--text); border: 1px solid #1f2333;
      border-radius: 12px; padding: 14px; font-size: 18px; font-weight: 600;
      display:flex; align-items:center; justify-content:center;
      transition: background .15s ease, transform .05s ease;
      user-select: none; -webkit-tap-highlight-color: transparent;
    }
    .btn:active { transform: translateY(1px); }
    .btn:hover { background: var(--btn-hover); }
    .btn.func { font-size: 15px; font-weight: 700; }
    .funcs {
      display:grid; grid-template-columns: repeat(3, 1fr); gap: 8px; padding: 0 12px 12px;
    }
    .btn.primary { background: #123; border-color: #254; color: #d1fae5; }
    .btn.primary:hover { background: #0e2b3a; }
    .btn.accent { background: #0e2230; border-color: #1f3b4f; color: #c7f9ff; }
    .btn.ok { background: #0f2a1d; border-color: #1e5c3e; color: #bbf7d0; }
    .btn.warn { background: #2d210a; border-color: #5a420f; color: #fed7aa; }
    .btn.danger { background: #2b0f12; border-color: #5b1f25; color: #fecaca; }
    .footer {
      padding: 10px 12px; font-size: 12px; color: var(--muted); display:flex; justify-content: space-between; gap: 8px;
      border-top: 1px solid #1f2333;
    }
    .overlay {
      position: fixed; inset: 0; background: rgba(0,0,0,.72);
      display:none; align-items: center; justify-content: center; z-index: 50;
      backdrop-filter: blur(2px);
    }
    .modal {
      width: min(520px, 96vw); background: #0b0f18; border: 1px solid #1f2333; border-radius: 14px; overflow: hidden;
    }
    .modal .head { display:flex; justify-content: space-between; align-items:center; padding: 10px 12px; background: #0a0d16; color: #9fb3d6; font-size: 13px; }
    .modal .body { padding: 12px; display:grid; gap: 10px; }
    .videoWrap {
      position: relative; border-radius: 12px; overflow: hidden; border: 1px solid #1f2333; background: #000;
      aspect-ratio: 16/10; display:grid; place-items:center;
    }
    video { width: 100%; height: 100%; object-fit: cover; }
    canvas { display:none; }
    .badge {
      display:inline-flex; align-items:center; gap: 6px; font-size: 12px; padding: 6px 8px; border-radius: 999px;
      background: #0f172a; border: 1px solid #1f2333; color: #cbd5e1;
    }
    .row { display:flex; align-items:center; gap: 10px; flex-wrap: wrap; }
    .progress {
      height: 8px; border-radius: 999px; background: #0f172a; border: 1px solid #1f2333; overflow:hidden;
    }
    .progress > span { display:block; height: 100%; width: 0%; background: linear-gradient(90deg, var(--accent), var(--accent-2)); transition: width .2s ease; }
    .code { font-variant-numeric: tabular-nums; letter-spacing: 2px; font-weight: 800; }
    .muted { color: var(--muted); }
    .sr { position:absolute; width:1px; height:1px; padding:0; overflow:hidden; clip:rect(0,0,0,0); white-space:nowrap; border:0; }
  </style>
  <!-- QR decoder -->
  <script src="https://cdn.jsdelivr.net/npm/jsqr@1.4.0/dist/jsQR.min.js"></script>
</head>
<body>
  <div class="wrap">
    <div class="terminal" role="application" aria-label="Symulacja terminala płatniczego">
      <div class="topbar">
        <span>Symulacja terminala</span>
        <span id="conn" class="badge">Online</span>
      </div>

      <div class="screen" id="screen">
        <div class="amount" id="amount">0,00 zł</div>
        <div class="status" id="status">Wprowadź kwotę i wybierz metodę płatności.</div>
        <div class="hint" id="hint">Dostępne: Karta (zbliż), BLIK (6 cyfr), Oszołom (QR).</div>
      </div>

      <div class="grid" aria-label="Klawiatura numeryczna">
        <button class="btn" data-key="1">1</button>
        <button class="btn" data-key="2">2</button>
        <button class="btn" data-key="3">3</button>
        <button class="btn" data-key="4">4</button>
        <button class="btn" data-key="5">5</button>
        <button class="btn" data-key="6">6</button>
        <button class="btn" data-key="7">7</button>
        <button class="btn" data-key="8">8</button>
        <button class="btn" data-key="9">9</button>
        <button class="btn warn" id="clear">C</button>
        <button class="btn" data-key="0">0</button>
        <button class="btn" id="back">←</button>
      </div>

      <div class="funcs" aria-label="Przyciski funkcyjne">
        <button class="btn func accent" id="blikBtn">BLIK</button>
        <button class="btn func ok" id="cardBtn">Karta</button>
        <button class="btn func primary" id="qrBtn">Oszołom (QR)</button>
      </div>

      <div class="footer">
        <span>To tylko symulacja — nic nie jest naprawdę przetwarzane.</span>
        <button class="btn danger" style="padding:6px 10px;font-size:13px;border-radius:8px" id="cancel">Anuluj</button>
      </div>
    </div>
  </div>

  <!-- Modal: Kamera / Karta / QR -->
  <div class="overlay" id="overlay" aria-hidden="true">
    <div class="modal" role="dialog" aria-modal="true" aria-labelledby="modalTitle">
      <div class="head">
        <div class="row">
          <span id="modalTitle">Kamera</span>
          <span class="badge" id="modeBadge">Tryb</span>
        </div>
        <button class="btn danger" style="padding:6px 10px;font-size:13px;border-radius:8px" id="closeModal">Zamknij</button>
      </div>
      <div class="body">
        <div class="videoWrap">
          <video id="video" playsinline autoplay muted></video>
          <canvas id="canvas"></canvas>
        </div>
        <div class="row">
          <span class="badge" id="infoBadge">Przygotowywanie...</span>
          <span class="badge" id="brightnessBadge">Jasność: —</span>
          <span class="badge" id="progressBadge">Postęp: 0%</span>
        </div>
        <div class="progress" aria-label="Postęp wykrycia">
          <span id="progressBar"></span>
        </div>
        <div class="muted" id="modalHint">Udziel dostępu do kamery.</div>
      </div>
    </div>
  </div>

  <!-- Modal: BLIK -->
  <div class="overlay" id="blikOverlay" aria-hidden="true">
    <div class="modal" role="dialog" aria-modal="true" aria-labelledby="blikTitle">
      <div class="head">
        <span id="blikTitle">Płatność BLIK</span>
        <button class="btn danger" style="padding:6px 10px;font-size:13px;border-radius:8px" id="closeBlik">Zamknij</button>
      </div>
      <div class="body">
        <div>
          <div>Kwota: <strong id="blikAmount">0,00 zł</strong></div>
          <div>Kod BLIK: <span class="code" id="blikCode">——— ——</span></div>
        </div>
        <div class="grid" id="blikPad">
          <button class="btn" data-b="1">1</button><button class="btn" data-b="2">2</button><button class="btn" data-b="3">3</button>
          <button class="btn" data-b="4">4</button><button class="btn" data-b="5">5</button><button class="btn" data-b="6">6</button>
          <button class="btn" data-b="7">7</button><button class="btn" data-b="8">8</button><button class="btn" data-b="9">9</button>
          <button class="btn warn" id="blikClear">C</button><button class="btn" data-b="0">0</button>
          <button class="btn ok" id="blikAccept">OK</button>
        </div>
        <div class="muted" id="blikHint">Wpisz 6 cyfr i naciśnij OK.</div>
      </div>
    </div>
  </div>

  <script>
    // ------------------------
    // Prosta logika terminala
    // ------------------------
    const amountEl = document.getElementById('amount');
    const statusEl = document.getElementById('status');
    const hintEl   = document.getElementById('hint');
    const keypad   = document.querySelectorAll('.grid .btn[data-key]');
    const clearBtn = document.getElementById('clear');
    const backBtn  = document.getElementById('back');
    const cardBtn  = document.getElementById('cardBtn');
    const blikBtn  = document.getElementById('blikBtn');
    const qrBtn    = document.getElementById('qrBtn');
    const cancel   = document.getElementById('cancel');

    let cents = 0; // kwota w groszach

    function fmtAmount(c) {
      const z = (c/100).toFixed(2).replace('.', ',');
      return `${z} zł`;
    }
    function updateAmount() {
      amountEl.textContent = fmtAmount(cents);
      statusEl.textContent = 'Wybierz metodę płatności.';
    }
    keypad.forEach(btn => {
      btn.addEventListener('click', () => {
        const d = btn.dataset.key;
        // wprowadzamy jak w terminalu: cyfra dopisuje grosze z przesunięciem
        cents = Math.min(99999999, Math.max(0, cents*10 + Number(d)));
        updateAmount();
      });
    });
    clearBtn.onclick = () => { cents = 0; updateAmount(); };
    backBtn.onclick  = () => { cents = Math.floor(cents/10); updateAmount(); };

    cancel.onclick = () => {
      cents = 0; updateAmount();
      statusEl.textContent = 'Anulowano. Wprowadź kwotę ponownie.';
      stopCamera();
      hideOverlays();
    };

    // ------------------------
    // BLIK modal
    // ------------------------
    const blikOverlay = document.getElementById('blikOverlay');
    const blikAmount  = document.getElementById('blikAmount');
    const blikCodeEl  = document.getElementById('blikCode');
    const blikPad     = document.getElementById('blikPad');
    const blikClear   = document.getElementById('blikClear');
    const blikAccept  = document.getElementById('blikAccept');
    const closeBlik   = document.getElementById('closeBlik');
    const blikHint    = document.getElementById('blikHint');

    let blikCode = "";

    function showBlik() {
      blikAmount.textContent = fmtAmount(cents);
      blikCode = "";
      drawBlikCode();
      blikHint.textContent = 'Wpisz 6 cyfr i naciśnij OK.';
      blikOverlay.style.display = 'flex';
      blikOverlay.setAttribute('aria-hidden', 'false');
    }
    function hideBlik() {
      blikOverlay.style.display = 'none';
      blikOverlay.setAttribute('aria-hidden', 'true');
    }
    function drawBlikCode() {
      const view = (blikCode.padEnd(6, '—').slice(0,3) + ' ' + blikCode.padEnd(6, '—').slice(3,6))
      blikCodeEl.textContent = view;
    }
    blikPad.addEventListener('click', (e) => {
      const v = e.target.dataset?.b;
      if (!v) return;
      if (blikCode.length < 6) {
        blikCode += v;
        drawBlikCode();
      }
    });
    blikClear.onclick = () => { blikCode = ""; drawBlikCode(); };
    blikAccept.onclick = () => {
      if (blikCode.length !== 6) {
        blikHint.textContent = 'Kod musi mieć 6 cyfr.';
        return;
      }
      blikHint.textContent = 'Wysyłanie prośby o potwierdzenie w aplikacji...';
      blikAccept.disabled = true;
      setTimeout(() => {
        blikHint.textContent = 'Oczekiwanie na potwierdzenie banku...';
        setTimeout(() => {
          blikHint.textContent = 'Płatność zaakceptowana ✅';
          statusEl.textContent = `BLIK: płatność ${fmtAmount(cents)} zakończona powodzeniem.`;
          setTimeout(() => { hideBlik(); }, 1200);
        }, 1400);
      }, 900);
    };
    closeBlik.onclick = hideBlik;
    blikBtn.onclick = () => {
      if (cents <= 0) { statusEl.textContent = 'Podaj kwotę, zanim wybierzesz BLIK.'; return; }
      showBlik();
    };

    // ------------------------
    // Kamera / Karta / QR
    // ------------------------
    const overlay      = document.getElementById('overlay');
    const closeModal   = document.getElementById('closeModal');
    const video        = document.getElementById('video');
    const canvas       = document.getElementById('canvas');
    const modeBadge    = document.getElementById('modeBadge');
    const infoBadge    = document.getElementById('infoBadge');
    const brightBadge  = document.getElementById('brightnessBadge');
    const progressBadge= document.getElementById('progressBadge');
    const progressBar  = document.getElementById('progressBar');
    const modalHint    = document.getElementById('modalHint');

    let stream = null;
    let rafId = null;
    let mode = null; // 'card' | 'qr'
    let darkScore = 0;

    // Tolerancja ciemności (wybaczająca, ale nie za duża)
    const DARK_THRESHOLD = 50; // 0-255: przeciętna jasność; <50 uznajemy za "ciemno"
    const REQUIRED_DARK_FRAMES = 10; // kolejne "ciemne" próbki (ok. ~1 s)

    function showOverlay(m) {
      mode = m;
      overlay.style.display = 'flex';
      overlay.setAttribute('aria-hidden', 'false');
      modeBadge.textContent = (m === 'card') ? 'Tryb: Karta (zbliżeniowa)' : 'Tryb: Oszołom (QR)';
      infoBadge.textContent = 'Uruchamianie kamery...';
      brightBadge.textContent = 'Jasność: —';
      progressBadge.textContent= 'Postęp: 0%';
      progressBar.style.width = '0%';
      modalHint.textContent = (m === 'card')
        ? 'Zasłoń obiektyw kartą/telefonem — wykryjemy przyłożenie.'
        : 'Skieruj kamerę na dowolny kod QR.';
      startCamera();
    }
    function hideOverlay() {
      overlay.style.display = 'none';
      overlay.setAttribute('aria-hidden', 'true');
    }
    function hideOverlays() {
      hideOverlay(); hideBlik();
    }

    async function startCamera() {
      stopCamera();
      try {
        stream = await navigator.mediaDevices.getUserMedia({
          video: { facingMode: 'environment' },
          audio: false
        });
        video.srcObject = stream;
        await video.play();
        canvas.width = video.videoWidth || 640;
        canvas.height= video.videoHeight || 360;
        darkScore = 0;
        infoBadge.textContent = 'Kamera gotowa';
        loop();
      } catch (e) {
        infoBadge.textContent = 'Brak dostępu do kamery';
        modalHint.textContent = 'Zezwól na aparat i otwórz przez HTTPS.';
      }
    }
    function stopCamera() {
      if (rafId) cancelAnimationFrame(rafId);
      rafId = null;
      if (stream) {
        stream.getTracks().forEach(t => t.stop());
        stream = null;
      }
    }
    function avgBrightness(ctx, w, h) {
      // Szybkie próbkowanie co 4 piksele
      const step = 4;
      const img = ctx.getImageData(0, 0, w, h).data;
      let sum = 0, count = 0;
      for (let y=0; y<h; y+=step) {
        for (let x=0; x<w; x+=step) {
          const i = (y*w + x) * 4;
          const r = img[i], g = img[i+1], b = img[i+2];
          // luminancja percepcyjna
          const Y = 0.2126*r + 0.7152*g + 0.0722*b;
          sum += Y; count++;
        }
      }
      return sum / count;
    }
    function setProgress(p) {
      const pct = Math.max(0, Math.min(100, Math.round(p*100)));
      progressBar.style.width = pct + '%';
      progressBadge.textContent = 'Postęp: ' + pct + '%';
    }

    function loop() {
      const ctx = canvas.getContext('2d');
      const w = canvas.width, h = canvas.height;
      ctx.drawImage(video, 0, 0, w, h);

      if (mode === 'card') {
        // detekcja ciemności
        const b = avgBrightness(ctx, w, h);
        brightBadge.textContent = 'Jasność: ' + Math.round(b);
        if (b < DARK_THRESHOLD) {
          darkScore = Math.min(REQUIRED_DARK_FRAMES, darkScore + 1);
        } else {
          // lekka histereza: zmniejszaj powoli
          darkScore = Math.max(0, darkScore - 1);
        }
        setProgress(darkScore / REQUIRED_DARK_FRAMES);

        if (darkScore >= REQUIRED_DARK_FRAMES) {
          infoBadge.textContent = 'Wykryto przyłożenie karty ✅';
          statusEl.textContent = `Karta: płatność ${fmtAmount(cents)} zaakceptowana.`;
          setTimeout(() => { hideOverlay(); stopCamera(); }, 400);
          return;
        }
      } else if (mode === 'qr') {
        // skan QR
        const img = ctx.getImageData(0, 0, w, h);
        const code = jsQR(img.data, w, h, { inversionAttempts: 'dontInvert' });
        if (code) {
          infoBadge.textContent = 'QR wykryty ✅';
          statusEl.textContent = `Oszołom: przyjęto kod: ${code.data.substring(0,80)}${code.data.length>80?'…':''}`;
          setProgress(1);
          setTimeout(() => { hideOverlay(); stopCamera(); }, 400);
          return;
        } else {
          infoBadge.textContent = 'Skanowanie...';
        }
      }

      rafId = requestAnimationFrame(loop);
    }

    closeModal.onclick = () => { hideOverlay(); stopCamera(); };

    cardBtn.onclick = () => {
      if (cents <= 0) { statusEl.textContent = 'Podaj kwotę, zanim wybierzesz Kartę.'; return; }
      showOverlay('card');
    };
    qrBtn.onclick = () => {
      if (cents <= 0) { statusEl.textContent = 'Podaj kwotę, zanim wybierzesz Oszołom (QR).'; return; }
      showOverlay('qr');
    };

    // UX: automatyczne ustawienie komunikatów
    updateAmount();

    // Dodatkowo: zamknij kamerę przy zmianie zakładki/ukryciu strony
    document.addEventListener('visibilitychange', () => {
      if (document.hidden) stopCamera();
    });

    // Fallback na wypadek braku HTTPS
    if (location.protocol !== 'https:' && location.hostname !== 'localhost') {
      document.getElementById('conn').textContent = 'Możliwy brak kamery (HTTPS zalecany)';
    }
  </script>
</body>
</html>
